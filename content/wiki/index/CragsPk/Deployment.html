
<!DOCTYPE html>
<html
 lang="en-us"
  prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#"
>
  





<head lang="en-us">
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark light">
  <meta name="description" content="" />
  <meta name="author" content="">
  <meta name="keywords" content="115, 116, 114, 105, 110, 103, 91, 93">
  <title>Deployment</title>
  <link rel="canonical" href="//localhost:1313/blog/" />
  
    <link
      href="../blog/index.xml"
      rel="alternate"
      type="application/rss+xml"
      title="Faaiz Ajaz"
    />
  

  
  <meta property="og:type" content="website" />
  <meta property="og:description" content="" />
  <meta property="og:title" content="Blogs" />
  <meta property="og:site_name" content="Faaiz Ajaz" />
  <meta property="og:image:type" content="image/jpeg" />
  <meta property="og:url" content="//localhost:1313/blog/" />
  <meta property="og:locale" content="en-us" />

  

  
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Blogs | Faaiz Ajaz" />
  <meta name="twitter:description" content="" />
  <meta name="twitter:domain" content="//localhost:1313/blog/" />

  
  
  
  
  

  
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/modern-normalize@1.0.0/modern-normalize.min.css">

  
  
  

  

  
<link rel="stylesheet" href="./style.min.24dece96ebe77a911ff4af20cffc54f5b46ee96ad7e33f168e1af342b043ec26.css" integrity="sha256-JN7OluvnepEf9K8gz/xU9bRu6WrX4z8WjhrzQrBD7CY=" rel="preload stylesheet" as="style"/>
    

  
  
</head>

  <body>
    <script>
  const currentTheme = window.localStorage.getItem('theme')
  if (currentTheme === "dark") {
    document.body.classList.toggle("theme-dark");
  } else if (currentTheme == "light") {
    document.body.classList.toggle("theme-light");
  }
</script>
<header id="header">
  <div class="row">
    <div class="container has-padding nav">
      <button id="navbar-toggler" class="navbar-button" aria-hidden="true">











<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><path d='M64 384h384v-42.67H64zm0-106.67h384v-42.66H64zM64 128v42.67h384V128z'/></svg>





</button>
      <div class="navbar-brand">
        <a class="logo navbar-button" href="../" title="Faaiz Ajaz">
          <span>Faaiz Ajaz</span>
        </a>
      </div>
      <nav class="navbar" role="navigation">
        <ul>
          
          
            <li class="nav-bar-item">
              <a class="nav-link navbar-button" href="../" title="about">
                <span>about</span>
              </a>
            </li>
          
            <li class="nav-bar-item">
              <a class="nav-link navbar-button" href="../blog/" title="blog">
                <span>blog</span>
              </a>
            </li>
          
            <li class="nav-bar-item active">
              <a class="nav-link navbar-button" href="../wiki/" title="wiki">
                <span>wiki</span>
              </a>
            </li>
          
        </ul>
      </nav>
      <div class="theme-selector">
        <button class="button is-text" id="theme-selector-button" title="toggle theme">
          <span class="label icon">





<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><path d='M256 32C132.29 32 32 132.29 32 256s100.29 224 224 224 224-100.29 224-224S379.71 32 256 32zM128.72 383.28A180 180 0 01256 76v360a178.82 178.82 0 01-127.28-52.72z'/></svg>











</span>
        </button>
      </div>
    </div>
    <div class="container has-padding">
      <div class="breadcrumb">
        
<ol  class="breadcrumb-nav">
  

  

<li >
  <a href="../">Home</a>
</li>


<li class="active">
  <a href="../wiki/">Wiki</a>
</li>

</ol>




      </div>
    </div>
  </div>
</header>

    
<main id="main" class="list">
  <div class="container has-padding">
    
    
<!-- Wiki content -->

  <h1>Deployment</h1>

<p>
<span class="zim-tag">@dokku</span> <span class="zim-tag">@deploy</span> <span class="zim-tag">@production</span> <span class="zim-tag">@server</span> 
</p>

<p>
This section covers how to deploy the website onto a VPS. There are a few different options here, from manually configuring Apache and WSGI, to using a PaaS like Heroku and Dokku.
</p>

<h3>Deploying with <a href="../Dokku.html" title="Dokku" class="page">Dokku</a></h3>

<p>
Dokku is nice because once set up, you just push updates to the repo on your server and it all happens pretty automatically. However setting it up is a pain in the ass. <br>
Also, the bible: <a href="https://cheat.readthedocs.io/en/latest/django/dokku.html" title="https://cheat.readthedocs.io/en/latest/django/dokku.html" class="https">https://cheat.readthedocs.io/en/latest/django/dokku.html</a>
</p>

<p>
<u>TIPS:</u><br>
<ul style='padding-left: 30pt'>
<li>Make sure your migrations are in your repo. Do not exclude them</li>
<li>You can <b>open a bash shell</b> to the running container by doing: <tt>dokku enter &lt;appname&gt;</tt> where appname is your DOKKU app name, NOT THE LOCAL DJANGO NAME</li>
<li><b>Run any command</b> using <tt>dokku run &lt;appname&gt; &lt;command&gt;</tt> e.g. <tt>dokku run mtnpak python manage.py collectstatic</tt> </li>
<li>You can see a <b>live view of the dokku logs</b> by doing on the server: <tt>dokku logs &lt;appname&gt; --tail</tt> </li>
<li>Setting up the <tt>PostgreSQL</tt> database is kind of a pain. Make sure your <tt>settings.py</tt> is correct</li>
</ul>
</p>

<h4>1) Installing Dokku</h4>

<p>
Installing is pretty easy, You can check on the official <a href="https://github.com/dokku/dokku" title="repo" class="https">repo</a>, or just follow these instructions:
</p>
<div class="zim-object">
<pre><code class="sh">$ wget https://raw.githubusercontent.com/dokku/dokku/v0.21.4/bootstrap.sh
$ sudo DOKKU_TAG=v0.21.4 bash bootstrap.sh
</code></pre>
</div>

<p>
Replace the value for <tt>DOKKU_TAG</tt> with the current version
</p>

<h4>2) Adding SSH keys and allowing host</h4>

<p>
You need to now visit the ip address of your remote machine in a browser, and in the Dokku form, paste your SSH public key.<br>
Then you must allow the <tt>dokku</tt> user to log in via ssh:
</p>
<div class="zim-object">
<pre><code class="sh">$ sudo nano /etc/ssh/sshd_config

# Add the dokku user to the following line
AllowUsers faaiz dokku
</code></pre>
</div>

<p>
Finally, as of writing this (August 2020) Dokku is weird in that it does not correctly set up the keys. I think this has something to do with the fact that I already use the same key for the <tt>faaiz</tt> user when I set up the VPS. Either way, you need to first check if <tt>dokku</tt> has any keys, then use dokku to add them if not:
</p>
<div class="zim-object">
<pre><code class="sh"># Check if there are any keys
$ dokku ssh-keys:list

# Chances are you'll get an error like:
/home/dokku/.ssh/authorized_keys line 1 failed ssh-keygen check.
# or
No public keys found 

# So what you need to do now, is delete that authorized_key file for the dokku user if there is one, copy your public key to some location on the server, and point dokku to it. You can pick your own key name
$ sudo dokku ssh-keys:add &lt;name_for_key&gt; /path/to/key

# Example of what I did
$ sudo dokku ssh-keys:add fa0 /home/faaiz/fa0-ssh-key

</code></pre>
</div>

<p>
Now you can test if this worked by seeing if you can SSH as the <tt>dokku</tt> user:
</p>
<div class="zim-object">
<pre><code class="sh">$ ssh dokku@&lt;your_server&gt;

# Example: I've set up my sshd_config to use port 333 for ssh, and use the hostname fa1

$ ssh dokku@fa1

# Output should be a bunch of dokku related help messages, then connection closes automatically. If this happens, then your SSH is working.
</code></pre>
</div>

<br>

<h4>3) Creating Dokku app and PostgreSQL database</h4>

<p>
Create a Dokku app and install the plugin for postgres
</p>
<div class="zim-object">
<pre><code class="sh"># Create app
$ dokku apps:create &lt;appname&gt;

# install postgres plugin
$ sudo dokku plugin:install https://github.com/dokku/dokku-postgres.git

# create a db
dokku postgres:create &lt;dbname&gt;

# link db to app
dokku postgres:link &lt;dbname&gt; &lt;appname&gt;

</code></pre>
</div>

<br>

<h4>4) Configure domains and add repository</h4>

<p>
In your server running Dokku, you want to add your domains for some reason (I don't understand this, since I do my domain stuff on Vultr DNS) but in any case, this is how they want you to do it:<br>
<div style='padding-left: 30pt'>
<tt>$ dokku domains:add &lt;appname&gt; subdomain.domain.com</tt>  # I think I can just do <tt>domain.com</tt> to serve from the root domain
</div>
</p>

<p>
Then you need to go to your local machine and add your remote repository. You will push to this when you want to deploy the website.<br>
<div style='padding-left: 30pt'>
<tt>&gt; git remote add dokku dokku@&lt;host_name&gt;:&lt;appname&gt;</tt>
</div>
You can call the repo whatever you want (in this case <tt>dokku</tt>) but the user HAS to be <tt>dokku</tt> 
</p>

<p>
<u><b>IMPORTANT</b>:</u> If you are using a subdomain, make sure to add <tt>.domain.tld</tt> to your Django <tt>ALLOWED_HOSTS</tt> to tell it to accept serving from a subdomain. Otherwise it will not. You also need to add <tt>domain.tld</tt> without the <tt>.</tt> if you are just trying to serve it from the root domain.
</p>

<h4>5) Add the correct buildpacks</h4>

<p>
You need a buildpack for python and for GDAL. For some reason, the documented way doesn't work for me. What I need to do is create a file called <tt>.buildpacks</tt> in the root of my local project repo, and add to the contents:<br>
<div style='padding-left: 30pt'>
<tt>https://github.com/heroku/heroku-geo-buildpack.git</tt><br>
<tt>https://github.com/heroku/heroku-buildpack-python.git</tt>
</div>
</p>

<h4>6) Set up the Procfile</h4>

<p>
In the root of your local project directory, create a file called <tt>Procfile</tt> and add to its contents:
</p>
<div class="zim-object">
<pre><code class="sh"># This is the WSGI setting for Gunicorn. Make sure 'MTNPAK.wgsi' is the path to your wsgi.py in dot form, i.e. '/' replaced by '.'
web: gunicorn MTNPAK.wsgi:application

# This runs commands during deploy: make migrations, migrate db, and then load the grades fixture data
release: python manage.py makemigrations; python manage.py migrate --noinput; python manage.py loaddata grades.json
</code></pre>
</div>

<p>
Load whatever else fixtures you need here.
</p>

<h4>7) Create your Django superuser</h4>

<p>
Easy enough. Once container is running, do:<br>
<tt>dokku run &lt;appname&gt; python manage.py createsuperuser</tt>
</p>

<h4>8) Set up persistent storage for media</h4>

<p>
<a href="http://dokku.viewdocs.io/dokku/advanced-usage/persistent-storage/" title="http://dokku.viewdocs.io/dokku/advanced-usage/persistent-storage/" class="http">http://dokku.viewdocs.io/dokku/advanced-usage/persistent-storage/</a><br>
<u><b>IMPORTANT</b>:</u> <br>
<div style='padding-left: 60pt'>
When <tt>DEBUG=False</tt> in your <tt>settings.py</tt> you need to manually configure <tt>nginx</tt> to correctly serve your media files in the container. Copy the contents from <a href="https://github.com/dokku/dokku/blob/master/plugins/nginx-vhosts/templates/nginx.conf.sigil" title="here" class="https">here</a> and paste them into a file called <tt>nginx.conf.sigil</tt> in your project root (where <tt>Procfile</tt> is). Look for loops with <tt>http</tt> and <tt>https</tt> conditionals, and before the first <tt>location / {...}</tt> statement for both <tt>http</tt> and <tt>https</tt> (where <tt>/</tt> means site root, add another <tt>location</tt> statement: 	
</div>
<div style='padding-left: 90pt'>
<tt>location /media/ {</tt>
</div>
<div style='padding-left: 120pt'>
<tt>alias /var/lib/dokku/data/storage/&lt;appname&gt;;</tt>
</div>
<div style='padding-left: 90pt'>
<tt>}</tt>
</div>
<div style='padding-left: 60pt'>
This will tell your nginx to serve files at <tt>yoursite.com/media</tt> from the path on the server (NOT container) that you want (in this case <tt>/var/lib/dokku/data/storage/&lt;appname&gt;</tt>
</div>
</p>

<p>
Django settings configurations as follows:<br>
<div style='padding-left: 30pt'>
<tt>MEDIA_ROOT = '/storage</tt>'<br>
<tt>MEDIA_URL = '/media/</tt>'
</div>
Dokku's default storage mount point in the container is <tt>/storage</tt> and I have no reason to change that<br>
Then, on the server, you want to create a folder for your app in:<br>
<div style='padding-left: 30pt'>
<tt>$ mkdir -p /var/lib/dokku/data/storage/&lt;appname&gt;</tt>
</div>
Then, you must set the permissions so that dokku and your container have access (32767 is the default container group id if you are using buildpacks:<br>
<div style='padding-left: 30pt'>
<tt>$ sudo chown -R dokku:dokku /var/lib/dokku/data/storage/&lt;appname&gt;</tt><br>
<tt>$ sudo chown -R 32767:32767 /var/lib/dokku/data/storage/&lt;appname&gt;</tt>
</div>
Then just mount the storage. This command mounts your server storage directory to a folder in the container <tt>/storage.</tt><br>
<div style='padding-left: 30pt'>
<tt>$ dokku storage: mount &lt;appname&gt; /var/lib/dokku/data/storage/&lt;appname&gt;:/storage</tt>
</div>
Check that your storage is mounted correctly, then restart the container<br>
<div style='padding-left: 30pt'>
<tt>$ dokku storage:list &lt;apname&gt;</tt> <br>
<tt>$ dokku ps:rebuild &lt;appname&gt;</tt>
</div>
This storage should remain mounted to the app unless you destroy and redeploy your server
</p>

<br>

<h4>9) Configure Whitenoise to serve static files</h4>

<p>
<u>DO NOT DO THIS ON HIGH TRAFFIC WEBSITES</u><br>
<a href="http://whitenoise.evans.io/en/stable/django.html" title="http://whitenoise.evans.io/en/stable/django.html" class="http">http://whitenoise.evans.io/en/stable/django.html</a><br>
This is a cheap (free) option to let Django serve static files. Obviously, you need to <tt>pip3 install whitenoise</tt> first and foremost. Then follow the steps below and make changes in <tt>settings.py</tt>.
</p>

<p>
You need to make sure that <tt>STATIC_ROOT</tt> is properly configured in your <tt>settings.py</tt> :<br>
<div style='padding-left: 30pt'>
<tt>STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles')</tt>
</div>
And all your static file loading should be using the <tt>{% static ... %}</tt> template tag.
</p>

<p>
<b>Then run</b> <tt>manage.py collectstatic </tt>to collect all your static files to the <tt>staticfiles</tt> folder
</p>

<p>
Then add '<tt>whitenoise.middleware.WhiteNoiseMiddleware</tt>' to your middleware (should be second in line behind <tt>SecurityMiddleware</tt> 
</p>

<p>
Add <tt>STATICFILES_STORAGE = 'whitenoise.storage.CompressedManifestStaticFilesStorage</tt>' for compression and caching OR<br>
<tt>STATICFILES_STORAGE = 'whitenoise.storage.CompressedStaticFilesStorage</tt>' for just compression.
</p>

<p>
Then, you need to make it such that <tt>whitenoise</tt> serves static files even when you are using your runserver in development. Do this by adding the following to the TOP of your <tt>INSTALLED_APPS</tt> :<br>
<div style='padding-left: 30pt'>
'<tt>whitenoise.runserver_nostatic</tt>' 
</div>
Easy pease.
</p>

<h4>10) Add SSL certificates</h4>

<p>
<a href="https://github.com/dokku/dokku-letsencrypt" title="https://github.com/dokku/dokku-letsencrypt" class="https">https://github.com/dokku/dokku-letsencrypt</a><br>
First, install the letsencrypt plugin:<br>
<div style='padding-left: 30pt'>
<tt>$ sudo dokku plugin:install https://github.com/dokku/dokku-letsencrypt.git</tt>
</div>
Then set your email for the certificate:<br>
<div style='padding-left: 30pt'>
<tt>$ dokku config:set --no-restart &lt;appname&gt; DOKKU_LETSENCRYPT_EMAIL=&lt;email&gt;</tt> 
</div>
or, for global email setting, do:<br>
<div style='padding-left: 30pt'>
<tt>$ dokku config:set --no-restart --global DOKKU_LETSENCRYPT_EMAIL=&lt;email&gt;</tt>
</div>
Finally, set auto-renewal of certs by doing:<br>
<div style='padding-left: 30pt'>
<tt>$ dokku letsencrypt:cron-job --add</tt>
</div>
</p>

<p>
DEPLOY WITH 'git push dokku master:mater'
</p>

<br>



<!-- End wiki content -->



  </div>
</main>

    <footer id="footer">
  <div class="container has-padding is-flex">
    <ul class="links">
      
      
    </ul>
    <div class="copyright">
       &copy; 2021 Faaiz Ajaz
      
    </div>
  </div>
</footer>

<script>
    window.FluencyCopyIcon = '\n\n\n\n\n\n\n\u003csvg xmlns=\u0027http:\/\/www.w3.org\/2000\/svg\u0027 class=\u0027ionicon\u0027 viewBox=\u00270 0 512 512\u0027\u003e\u003crect x=\u0027128\u0027 y=\u0027128\u0027 width=\u0027336\u0027 height=\u0027336\u0027 rx=\u002757\u0027 ry=\u002757\u0027 stroke-linejoin=\u0027round\u0027 class=\u0027ionicon-fill-none ionicon-stroke-width\u0027\/\u003e\u003cpath d=\u0027M383.5 128l.5-24a56.16 56.16 0 00-56-56H112a64.19 64.19 0 00-64 64v216a56.16 56.16 0 0056 56h24\u0027 stroke-linecap=\u0027round\u0027 stroke-linejoin=\u0027round\u0027 class=\u0027ionicon-fill-none ionicon-stroke-width\u0027\/\u003e\u003c\/svg\u003e\n\n\n\n\n\n\n\n\n\n\n'
</script>


<script defer src="./js/main.min.7685c4d03abca7fd02a772a2e64c7a8aa3a7031024bbab70a17975e8928cb004.js" integrity="sha256-doXE0Dq8p/0Cp3Ki5kx6iqOnAxAku6twoXl16JKMsAQ=" crossorigin="anonymous" async></script>




<noscript>
<style type=text/css>#theme-selector-button{display:none}</style>
</noscript>




  <script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script></body>
</html>
